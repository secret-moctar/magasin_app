{% extends "base.html" %}

{% block title %}Overdue Tools Report{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/inventory.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}

{% block content %}
<div class="p-6">
    <div class="bg-white shadow-sm mb-6 animate__animated animate__fadeInDown">
        <div class="max-w-4xl mx-auto px-4 py-6 flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <h1 class="text-2xl font-bold text-red-700">Outils en retard</h1>
            <div class="mt-4 sm:mt-0 flex gap-2">
                <button type="button" id="filterToggle" class="inline-flex items-center px-4 py-2 rounded-md shadow-sm text-sm font-medium text-red-700 bg-red-100 hover:bg-red-200 transition">
                    <i class="fas fa-filter mr-2"></i>
                    Filtres
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div id="filterSection" class="bg-white border-b border-gray-200 shadow-sm hidden transition-all mb-6 rounded animate__animated animate__fadeIn">
        <div class="max-w-4xl mx-auto px-4 py-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <label for="searchTool" class="block text-sm font-medium text-gray-700 mb-1">Outil</label>
                <input type="text" id="searchTool" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Nom ou ID outil">
            </div>
            <div>
                <label for="searchEmployee" class="block text-sm font-medium text-gray-700 mb-1">Employé</label>
                <input type="text" id="searchEmployee" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Nom ou ID employé">
            </div>
            <div>
                <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-1">Date prévue retour</label>
                <input type="date" id="dateFilter" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm">
            </div>
            <div class="col-span-1 md:col-span-4 flex gap-2 justify-end mt-2">
                <button type="button" id="applyFilters" class="inline-flex items-center px-4 py-2 rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition">
                    Appliquer
                </button>
                <button type="button" id="clearFilters" class="inline-flex items-center px-4 py-2 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 transition">
                    Réinitialiser
                </button>
            </div>
        </div>
    </div>

    <!-- Overdue Table -->
    <div class="max-w-5xl mx-auto animate__animated animate__fadeInUp">
        <div class="overflow-x-auto rounded-lg shadow">
            <table class="min-w-full divide-y divide-gray-200 bg-white">
                <thead class="bg-red-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Outil</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Employé</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Date emprunt</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Date prévue retour</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Jours de retard</th>
                    </tr>
                </thead>
                <tbody id="overdueTableBody" class="divide-y divide-gray-100">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
            <div id="overdueEmpty" class="text-center text-gray-500 py-8 hidden">Aucun outil en retard trouvé.</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('filterToggle').onclick = function() {
    document.getElementById('filterSection').classList.toggle('hidden');
};

function renderOverdues(overdues) {
    const tbody = document.getElementById('overdueTableBody');
    tbody.innerHTML = '';
    if (!overdues.length) {
        document.getElementById('overdueEmpty').classList.remove('hidden');
        return;
    }
    document.getElementById('overdueEmpty').classList.add('hidden');
    overdues.forEach(item => {
        tbody.innerHTML += `
        <tr class="hover:bg-red-50 transition animate__animated animate__fadeInUp">
            <td class="px-4 py-3 flex items-center gap-2">
                ${item.tool_photo ? `<img src="${item.tool_photo}" alt="${item.tool_name}" class="w-10 h-10 object-cover rounded shadow border border-gray-200">` : ''}
                <span class="font-semibold text-red-700">${item.tool_name || item.tool_id}</span>
            </td>
            <td class="px-4 py-3">
                <span class="font-medium text-gray-800">${item.employee_name || item.employee_id || '-'}</span>
            </td>
            <td class="px-4 py-3">${item.date_emprunt ? new Date(item.date_emprunt).toLocaleString() : '-'}</td>
            <td class="px-4 py-3">${item.expected_return ? new Date(item.expected_return).toLocaleDateString() : '-'}</td>
            <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded bg-red-600 text-white font-semibold animate__animated animate__fadeIn">${item.days_overdue}</span>
            </td>
        </tr>
        `;
    });
}

function fetchAndRenderOverdues() {
    const tool = document.getElementById('searchTool').value;
    const employee = document.getElementById('searchEmployee').value;
    const date = document.getElementById('dateFilter').value;
    let params = [];
    if (tool) params.push('tool=' + encodeURIComponent(tool));
    if (employee) params.push('employee=' + encodeURIComponent(employee));
    if (date) params.push('date=' + encodeURIComponent(date));
    fetch('/api/overdue?' + params.join('&'))
        .then(res => res.json())
        .then(data => renderOverdues(data));
}

document.getElementById('applyFilters').onclick = fetchAndRenderOverdues;
document.getElementById('clearFilters').onclick = function() {
    document.getElementById('searchTool').value = '';
    document.getElementById('searchEmployee').value = '';
    document.getElementById('dateFilter').value = '';
    fetchAndRenderOverdues();
};

document.addEventListener('DOMContentLoaded', fetchAndRenderOverdues);
</script>
{% endblock %}